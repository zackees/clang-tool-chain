name: win-gnu

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-windows-gnu:
    name: Windows x64 GNU ABI
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      shell: bash

    - name: Install package
      run: |
        uv venv
        uv pip install -e ".[dev]"
      shell: bash

    - name: Display platform information
      run: |
        echo "Platform: Windows x64 GNU ABI (MinGW)"
        uname -a || echo "Windows"
        python --version
        python -c "import platform; print(f'System: {platform.system()}'); print(f'Machine: {platform.machine()}')"
      shell: bash

    - name: Test CLI commands
      run: |
        uv run clang-tool-chain --help
        uv run clang-tool-chain package-version
        uv run clang-tool-chain list-tools
      shell: bash

    - name: Download and install toolchain
      run: |
        uv run clang-tool-chain-c --version
      shell: bash
      timeout-minutes: 20

    - name: Verify installation
      run: |
        uv run clang-tool-chain info
        uv run clang-tool-chain path
      shell: bash

    - name: Test GNU ABI C compilation
      run: |
        cat > test.c << 'EOF'
        #include <stdio.h>
        int main() {
            printf("Hello from Windows x64 GNU ABI!\n");
            return 0;
        }
        EOF
        uv run clang-tool-chain-c test.c -o test.exe
        ./test.exe
      shell: bash

    - name: Test GNU ABI C++ compilation
      run: |
        cat > test.cpp << 'EOF'
        #include <iostream>
        int main() {
            std::cout << "Hello C++ from Windows x64 GNU ABI!" << std::endl;
            return 0;
        }
        EOF
        uv run clang-tool-chain-cpp test.cpp -o test_cpp.exe
        ./test_cpp.exe
      shell: bash

    - name: Verify GNU target usage
      run: |
        cat > test_target.c << 'EOF'
        int main() { return 0; }
        EOF
        echo "Checking GNU target triple..."
        uv run clang-tool-chain-c -v -c test_target.c 2>&1 | grep -i "mingw\|gnu" && echo "GNU target confirmed!" || echo "Warning: GNU target not detected"
      shell: bash

    - name: Run integration tests
      run: |
        uv run pytest tests/test_integration.py -v
      shell: bash

    - name: Run GNU ABI specific tests
      run: |
        uv run pytest tests/test_gnu_abi.py -v
      shell: bash

    - name: Test Threading (Static Linking)
      run: |
        cat > test_threading.cpp << 'EOF'
        #include <iostream>
        #include <thread>
        #include <chrono>

        void worker(int id) {
            std::cout << "Worker " << id << " running on thread "
                      << std::this_thread::get_id() << std::endl;
            std::this_thread::sleep_for(std::chrono::milliseconds(100));
        }

        int main() {
            std::cout << "Testing threading with static linking..." << std::endl;
            std::thread t1(worker, 1);
            std::thread t2(worker, 2);
            t1.join();
            t2.join();
            std::cout << "Threading test successful!" << std::endl;
            return 0;
        }
        EOF
        echo "Building test_threading.exe..."
        uv run clang-tool-chain-cpp test_threading.cpp -o test_threading.exe -pthread

        # The toolchain now uses static linking for libc++ and libunwind,
        # so no MinGW DLLs need to be deployed. The executable is standalone.
        echo "Checking DLL deployment status..."
        if [ -f "libwinpthread-1.dll" ]; then
          echo "Note: libwinpthread-1.dll was deployed (dynamic linking mode)"
        else
          echo "Note: No MinGW DLLs deployed (static linking - standalone executable)"
        fi

        echo "Running executable in clean environment..."
        # Run in a clean PATH environment (minimal Windows system paths only)
        # This verifies the executable is truly standalone
        env -i SystemRoot="$SystemRoot" PATH="/c/Windows/System32:/c/Windows" ./test_threading.exe

        echo "✓ Threading test PASSED (standalone executable)"
      shell: bash

    - name: Test Exceptions and STL (Static Linking)
      run: |
        cat > test_exceptions.cpp << 'EOF'
        #include <iostream>
        #include <vector>
        #include <stdexcept>
        #include <memory>

        void test_function(int value) {
            if (value < 0) {
                throw std::runtime_error("Negative value not allowed");
            }
            std::cout << "Value: " << value << std::endl;
        }

        int main() {
            try {
                std::vector<int> numbers = {1, 2, 3, 4, 5};
                auto ptr = std::make_unique<int>(42);

                std::cout << "Testing exceptions and STL..." << std::endl;
                test_function(10);
                test_function(-1);  // Will throw
            } catch (const std::exception& e) {
                std::cout << "Caught exception: " << e.what() << std::endl;
            }
            std::cout << "Exception handling test successful!" << std::endl;
            return 0;
        }
        EOF
        echo "Building test_exceptions.exe..."
        uv run clang-tool-chain-cpp test_exceptions.cpp -o test_exceptions.exe

        # The toolchain uses static linking, so the executable is standalone
        echo "Checking DLL deployment status..."
        dll_count=0
        for dll in libwinpthread-1.dll libgcc_s_seh-1.dll libstdc++-6.dll libc++.dll libunwind.dll; do
          if [ -f "$dll" ]; then
            echo "Note: $dll was deployed"
            dll_count=$((dll_count + 1))
          fi
        done

        if [ $dll_count -eq 0 ]; then
          echo "Note: No MinGW DLLs deployed (static linking - standalone executable)"
        else
          echo "Note: $dll_count DLL(s) deployed (dynamic linking mode)"
        fi

        echo "Running executable in clean environment..."
        # This verifies the executable is standalone and doesn't require MinGW DLLs
        env -i SystemRoot="$SystemRoot" PATH="/c/Windows/System32:/c/Windows" ./test_exceptions.exe

        echo "✓ Exception handling test PASSED (standalone executable)"
      shell: bash

    - name: Test DLL Deployment Opt-Out
      run: |
        cat > test_optout.cpp << 'EOF'
        #include <iostream>
        int main() {
            std::cout << "Opt-out test" << std::endl;
            return 0;
        }
        EOF

        echo "Building with DLL deployment disabled..."
        # Remove any existing DLLs from previous tests
        rm -f libwinpthread-1.dll libgcc_s_seh-1.dll libstdc++-6.dll

        export CLANG_TOOL_CHAIN_NO_DEPLOY_DLLS=1
        uv run clang-tool-chain-cpp test_optout.cpp -o test_optout.exe

        echo "Checking that NO DLLs were deployed..."
        dll_found=false
        for dll in libwinpthread-1.dll libgcc_s_seh-1.dll libstdc++-6.dll; do
          if [ -f "$dll" ]; then
            echo "✗ $dll was deployed (should not have been)"
            dll_found=true
          fi
        done

        if [ "$dll_found" = true ]; then
          exit 1
        fi

        echo "✓ DLL deployment opt-out PASSED (no DLLs deployed)"
      shell: bash

    - name: Run DLL deployment tests
      run: |
        uv run pytest tests/test_dll_deployment.py -v
      shell: bash
