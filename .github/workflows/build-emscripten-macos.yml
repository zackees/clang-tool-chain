name: Build Emscripten macOS Archives

on:
  workflow_dispatch:
    inputs:
      upload_to_repo:
        description: 'Upload artifacts to downloads-bins repository (requires write access)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-emscripten-macos-x64:
    runs-on: macos-13  # Intel Mac
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyzstd

      - name: Build macOS x86_64 archive
        run: |
          cd downloads-bins/tools
          python3 fetch_and_archive_emscripten.py --platform darwin --arch x86_64

      - name: Display build results
        run: |
          echo "=== Build Complete ==="
          cd downloads-bins/assets/emscripten/darwin/x86_64
          ls -lh emscripten-*-darwin-x86_64.tar.zst* 2>/dev/null || echo "Archive not found"
          echo ""
          echo "=== Checksums ==="
          cat emscripten-*-darwin-x86_64.tar.zst.sha256 2>/dev/null || echo "SHA256 not found"
          echo ""
          echo "=== Manifest ==="
          cat manifest.json 2>/dev/null || echo "Manifest not found"

      - name: Verify critical files in archive
        run: |
          cd downloads-bins/assets/emscripten/darwin/x86_64
          mkdir -p test_extract
          cd test_extract
          tar --use-compress-program=unzstd -xf ../emscripten-*-darwin-x86_64.tar.zst
          echo "=== Checking for critical files ==="
          if [ -f "emscripten-version.txt" ]; then
            echo "✓ emscripten-version.txt found"
            cat emscripten-version.txt
          else
            echo "✗ emscripten-version.txt MISSING"
            exit 1
          fi
          if [ -d "upstream/emscripten" ]; then
            echo "✓ upstream/emscripten directory found"
            ls -la upstream/emscripten | head -20
          else
            echo "✗ upstream/emscripten directory MISSING"
            exit 1
          fi

      - name: Upload macOS x86_64 archive
        uses: actions/upload-artifact@v4
        with:
          name: emscripten-darwin-x86_64
          path: |
            downloads-bins/assets/emscripten/darwin/x86_64/emscripten-*.tar.zst
            downloads-bins/assets/emscripten/darwin/x86_64/emscripten-*.tar.zst.sha256
            downloads-bins/assets/emscripten/darwin/x86_64/emscripten-*.tar.zst.md5
            downloads-bins/assets/emscripten/darwin/x86_64/manifest.json

  build-emscripten-macos-arm64:
    runs-on: macos-latest  # Apple Silicon Mac (macos-14 or later)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyzstd

      - name: Build macOS ARM64 archive
        run: |
          cd downloads-bins/tools
          python3 fetch_and_archive_emscripten.py --platform darwin --arch arm64

      - name: Display build results
        run: |
          echo "=== Build Complete ==="
          cd downloads-bins/assets/emscripten/darwin/arm64
          ls -lh emscripten-*-darwin-arm64.tar.zst* 2>/dev/null || echo "Archive not found"
          echo ""
          echo "=== Checksums ==="
          cat emscripten-*-darwin-arm64.tar.zst.sha256 2>/dev/null || echo "SHA256 not found"
          echo ""
          echo "=== Manifest ==="
          cat manifest.json 2>/dev/null || echo "Manifest not found"

      - name: Verify critical files in archive
        run: |
          cd downloads-bins/assets/emscripten/darwin/arm64
          mkdir -p test_extract
          cd test_extract
          tar --use-compress-program=unzstd -xf ../emscripten-*-darwin-arm64.tar.zst
          echo "=== Checking for critical files ==="
          if [ -f "emscripten-version.txt" ]; then
            echo "✓ emscripten-version.txt found"
            cat emscripten-version.txt
          else
            echo "✗ emscripten-version.txt MISSING"
            exit 1
          fi
          if [ -d "upstream/emscripten" ]; then
            echo "✓ upstream/emscripten directory found"
            ls -la upstream/emscripten | head -20
          else
            echo "✗ upstream/emscripten directory MISSING"
            exit 1
          fi

      - name: Upload macOS ARM64 archive
        uses: actions/upload-artifact@v4
        with:
          name: emscripten-darwin-arm64
          path: |
            downloads-bins/assets/emscripten/darwin/arm64/emscripten-*.tar.zst
            downloads-bins/assets/emscripten/darwin/arm64/emscripten-*.tar.zst.sha256
            downloads-bins/assets/emscripten/darwin/arm64/emscripten-*.tar.zst.md5
            downloads-bins/assets/emscripten/darwin/arm64/manifest.json
