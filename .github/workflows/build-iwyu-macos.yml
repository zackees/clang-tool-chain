name: Build IWYU macOS Archives

# IMPORTANT: This workflow uses macOS runners which are expensive (~10x Linux costs)
# Total runtime: ~15-20 minutes (both architectures in parallel)
# Estimated cost: ~$0.16-0.32 USD per run (based on GitHub Actions pricing)

on:
  workflow_dispatch:
    inputs:
      upload_to_repo:
        description: 'Upload artifacts to downloads-bins repository (requires write access)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Prevent accidental concurrent runs
concurrency:
  group: iwyu-macos-build
  cancel-in-progress: false

jobs:
  build-iwyu-macos-x64:
    runs-on: macos-15-large  # Intel Mac for x86_64 (macos-13 is retired)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install zstandard
          brew install cmake

      - name: Build IWYU 0.22 for x86_64
        run: |
          cd downloads-bins/tools
          python3 build_iwyu_macos.py --arch x86_64

      - name: Create archive
        run: |
          cd downloads-bins/tools
          python3 create_iwyu_archives.py --platform darwin --arch x86_64 --version 0.22 --iwyu-root ../assets/iwyu

      - name: Display build results
        run: |
          echo "=== Build Complete ==="
          cd downloads-bins/assets/iwyu/darwin/x86_64
          ls -lh iwyu-*-darwin-x86_64.tar.zst* 2>/dev/null || echo "Archive not found"
          echo ""
          echo "=== Checksums ==="
          cat iwyu-*-darwin-x86_64.tar.zst.sha256 2>/dev/null || echo "SHA256 not found"

      - name: Upload macOS x86_64 archive
        uses: actions/upload-artifact@v4
        with:
          name: iwyu-darwin-x86_64
          path: |
            downloads-bins/assets/iwyu/darwin/x86_64/iwyu-*.tar.zst
            downloads-bins/assets/iwyu/darwin/x86_64/iwyu-*.tar.zst.sha256

  build-iwyu-macos-arm64:
    runs-on: macos-latest  # Apple Silicon Mac (macos-14 or later)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install zstandard
          brew install cmake

      - name: Build IWYU 0.25 for ARM64
        run: |
          cd downloads-bins/tools
          python3 build_iwyu_macos.py --arch arm64

      - name: Create archive
        run: |
          cd downloads-bins/tools
          python3 create_iwyu_archives.py --platform darwin --arch arm64 --version 0.25 --iwyu-root ../assets/iwyu

      - name: Display build results
        run: |
          echo "=== Build Complete ==="
          cd downloads-bins/assets/iwyu/darwin/arm64
          ls -lh iwyu-*-darwin-arm64.tar.zst* 2>/dev/null || echo "Archive not found"
          echo ""
          echo "=== Checksums ==="
          cat iwyu-*-darwin-arm64.tar.zst.sha256 2>/dev/null || echo "SHA256 not found"

      - name: Upload macOS ARM64 archive
        uses: actions/upload-artifact@v4
        with:
          name: iwyu-darwin-arm64
          path: |
            downloads-bins/assets/iwyu/darwin/arm64/iwyu-*.tar.zst
            downloads-bins/assets/iwyu/darwin/arm64/iwyu-*.tar.zst.sha256
