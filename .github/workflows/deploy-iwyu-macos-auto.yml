name: Deploy IWYU macOS Binaries (Automated)

# This workflow:
# 1. Extracts IWYU binaries from Homebrew (fast method)
# 2. Packages them into .tar.zst archives
# 3. Deploys to downloads-bins repository
# 4. Tests the deployed binaries
#
# Runtime: ~10-15 minutes total
# Runs: Weekly on Sundays at 2 AM UTC, or manually via workflow_dispatch

on:
  # Run weekly to check for Homebrew updates
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if version unchanged'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      skip_tests:
        description: 'Skip deployment tests (not recommended)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Prevent concurrent deployments
concurrency:
  group: iwyu-macos-deploy
  cancel-in-progress: false

permissions:
  contents: write  # Needed to push to downloads-bins

jobs:
  extract-and-package:
    name: Extract & Package (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            os: macos-latest      # Apple Silicon
          - arch: x86_64
            os: macos-15-large    # Intel (macos-13 retired)

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          submodules: true
          path: main-repo

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install zstandard

      - name: Display system information
        run: |
          echo "=== System Information ==="
          uname -a
          sw_vers
          arch
          echo ""
          echo "=== Homebrew Version ==="
          brew --version

      - name: Extract IWYU from Homebrew
        id: extract
        run: |
          cd main-repo/downloads-bins/tools
          python3 extract_iwyu_from_homebrew.py --arch ${{ matrix.arch }}

          # Get the version
          VERSION=$(main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/bin/include-what-you-use --version 2>&1 | grep -o '[0-9]\+\.[0-9]\+' | head -1)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted IWYU version: ${VERSION}"
        timeout-minutes: 10

      - name: Verify extracted binaries
        run: |
          echo "=== Binary Test ==="
          main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/bin/include-what-you-use --version

          echo ""
          echo "=== Dependencies Check ==="
          otool -L main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/bin/include-what-you-use

          echo ""
          echo "=== File Sizes ==="
          du -h main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/bin/include-what-you-use
          du -sh main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/lib/ 2>/dev/null || echo "No lib directory"

      - name: Create archive
        id: archive
        run: |
          cd main-repo/downloads-bins/tools
          VERSION="${{ steps.extract.outputs.version }}"
          python3 create_iwyu_archives.py \
            --platform darwin \
            --arch ${{ matrix.arch }} \
            --version "${VERSION}" \
            --iwyu-root ../assets/iwyu

          # Get archive info
          ARCHIVE_PATH="../assets/iwyu/darwin/${{ matrix.arch }}/iwyu-${VERSION}-darwin-${{ matrix.arch }}.tar.zst"
          ARCHIVE_SIZE=$(stat -f%z "${ARCHIVE_PATH}" 2>/dev/null || stat -c%s "${ARCHIVE_PATH}")
          ARCHIVE_SIZE_MB=$((ARCHIVE_SIZE / 1024 / 1024))
          SHA256=$(cat "${ARCHIVE_PATH}.sha256" | awk '{print $1}')

          echo "archive_path=${ARCHIVE_PATH}" >> $GITHUB_OUTPUT
          echo "archive_size_mb=${ARCHIVE_SIZE_MB}" >> $GITHUB_OUTPUT
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

          echo "Archive created: ${ARCHIVE_SIZE_MB} MB"
          echo "SHA256: ${SHA256}"
        timeout-minutes: 5

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: iwyu-darwin-${{ matrix.arch }}-${{ steps.extract.outputs.version }}
          path: |
            main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/iwyu-*.tar.zst
            main-repo/downloads-bins/assets/iwyu/darwin/${{ matrix.arch }}/iwyu-*.tar.zst.sha256
          retention-days: 90

      - name: Create deployment metadata
        run: |
          cat > deployment-info-${{ matrix.arch }}.json << EOF
          {
            "arch": "${{ matrix.arch }}",
            "version": "${{ steps.extract.outputs.version }}",
            "sha256": "${{ steps.archive.outputs.sha256 }}",
            "archive_size_mb": ${{ steps.archive.outputs.archive_size_mb }},
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runner_os": "${{ runner.os }}",
            "runner_arch": "${{ runner.arch }}"
          }
          EOF
          cat deployment-info-${{ matrix.arch }}.json

      - name: Upload metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: metadata-${{ matrix.arch }}
          path: deployment-info-${{ matrix.arch }}.json
          retention-days: 90

  deploy:
    name: Deploy to downloads-bins
    needs: extract-and-package
    runs-on: ubuntu-latest

    outputs:
      deployed_version: ${{ steps.check_version.outputs.version }}
      deployment_needed: ${{ steps.check_version.outputs.deployment_needed }}

    steps:
      - name: Checkout downloads-bins repository
        uses: actions/checkout@v4
        with:
          repository: zackees/clang-tool-chain-bins
          token: ${{ secrets.GITHUB_TOKEN }}
          path: downloads-bins
          ref: main

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f -ls

      - name: Load metadata
        id: metadata
        run: |
          echo "=== ARM64 Metadata ==="
          cat artifacts/metadata-arm64/deployment-info-arm64.json
          echo ""
          echo "=== x86_64 Metadata ==="
          cat artifacts/metadata-x86_64/deployment-info-x86_64.json

          # Extract version from ARM64 metadata (both should be same)
          VERSION=$(jq -r '.version' artifacts/metadata-arm64/deployment-info-arm64.json)
          ARM64_SHA256=$(jq -r '.sha256' artifacts/metadata-arm64/deployment-info-arm64.json)
          X64_SHA256=$(jq -r '.sha256' artifacts/metadata-x86_64/deployment-info-x86_64.json)

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "arm64_sha256=${ARM64_SHA256}" >> $GITHUB_OUTPUT
          echo "x64_sha256=${X64_SHA256}" >> $GITHUB_OUTPUT

      - name: Check if deployment needed
        id: check_version
        run: |
          VERSION="${{ steps.metadata.outputs.version }}"
          FORCE="${{ github.event.inputs.force_deploy }}"

          # Check current version in manifest
          CURRENT_VERSION=$(jq -r '.latest' downloads-bins/assets/iwyu/darwin/arm64/manifest.json 2>/dev/null || echo "none")

          echo "Current version: ${CURRENT_VERSION}"
          echo "New version: ${VERSION}"

          if [ "${CURRENT_VERSION}" = "${VERSION}" ] && [ "${FORCE}" != "true" ]; then
            echo "deployment_needed=false" >> $GITHUB_OUTPUT
            echo "::notice::IWYU version ${VERSION} already deployed. Skipping deployment."
          else
            echo "deployment_needed=true" >> $GITHUB_OUTPUT
            echo "::notice::Deploying IWYU version ${VERSION}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Copy archives to downloads-bins
        if: steps.check_version.outputs.deployment_needed == 'true'
        run: |
          VERSION="${{ steps.metadata.outputs.version }}"

          # ARM64
          cp artifacts/iwyu-darwin-arm64-${VERSION}/*.tar.zst \
             downloads-bins/assets/iwyu/darwin/arm64/
          cp artifacts/iwyu-darwin-arm64-${VERSION}/*.sha256 \
             downloads-bins/assets/iwyu/darwin/arm64/

          # x86_64
          cp artifacts/iwyu-darwin-x86_64-${VERSION}/*.tar.zst \
             downloads-bins/assets/iwyu/darwin/x86_64/
          cp artifacts/iwyu-darwin-x86_64-${VERSION}/*.sha256 \
             downloads-bins/assets/iwyu/darwin/x86_64/

      - name: Update manifests
        if: steps.check_version.outputs.deployment_needed == 'true'
        run: |
          VERSION="${{ steps.metadata.outputs.version }}"
          ARM64_SHA256="${{ steps.metadata.outputs.arm64_sha256 }}"
          X64_SHA256="${{ steps.metadata.outputs.x64_sha256 }}"

          # Update ARM64 manifest
          jq --arg version "${VERSION}" \
             --arg sha256 "${ARM64_SHA256}" \
             '.latest = $version | .[$version] = {
               "href": "https://media.githubusercontent.com/media/zackees/clang-tool-chain-bins/main/assets/iwyu/darwin/arm64/iwyu-\($version)-darwin-arm64.tar.zst",
               "sha256": $sha256
             }' downloads-bins/assets/iwyu/darwin/arm64/manifest.json > temp.json
          mv temp.json downloads-bins/assets/iwyu/darwin/arm64/manifest.json

          # Update x86_64 manifest
          jq --arg version "${VERSION}" \
             --arg sha256 "${X64_SHA256}" \
             '.latest = $version | .[$version] = {
               "href": "https://media.githubusercontent.com/media/zackees/clang-tool-chain-bins/main/assets/iwyu/darwin/x86_64/iwyu-\($version)-darwin-x86_64.tar.zst",
               "sha256": $sha256
             }' downloads-bins/assets/iwyu/darwin/x86_64/manifest.json > temp.json
          mv temp.json downloads-bins/assets/iwyu/darwin/x86_64/manifest.json

          echo "=== Updated ARM64 Manifest ==="
          cat downloads-bins/assets/iwyu/darwin/arm64/manifest.json
          echo ""
          echo "=== Updated x86_64 Manifest ==="
          cat downloads-bins/assets/iwyu/darwin/x86_64/manifest.json

      - name: Commit and push to downloads-bins
        if: steps.check_version.outputs.deployment_needed == 'true'
        run: |
          cd downloads-bins

          VERSION="${{ steps.metadata.outputs.version }}"
          ARM64_SIZE=$(jq -r '.archive_size_mb' ../artifacts/metadata-arm64/deployment-info-arm64.json)
          X64_SIZE=$(jq -r '.archive_size_mb' ../artifacts/metadata-x86_64/deployment-info-x86_64.json)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add assets/iwyu/darwin/

          git commit -m "fix(iwyu): Deploy macOS binaries v${VERSION} from Homebrew

Automated deployment from Homebrew extraction method.

Details:
- IWYU Version: ${VERSION}
- ARM64: ${ARM64_SIZE} MB (SHA256: ${{ steps.metadata.outputs.arm64_sha256 }})
- x86_64: ${X64_SIZE} MB (SHA256: ${{ steps.metadata.outputs.x64_sha256 }})
- Build Date: $(date -u +%Y-%m-%d)
- Method: Homebrew extraction with bundled LLVM dylibs

Fixes:
- Resolves SIGABRT crashes from missing LLVM symbols
- Bundles required LLVM dylibs for portability
- Uses @executable_path for relative dylib loading

Testing:
- Binaries verified with otool -L
- Version command tested successfully
- Ready for CI validation"

          git push origin main

          echo "::notice::Successfully deployed IWYU ${VERSION} to downloads-bins"

  test-deployment:
    name: Test Deployed Binaries (${{ matrix.arch }})
    needs: deploy
    if: needs.deploy.outputs.deployment_needed == 'true' && github.event.inputs.skip_tests != 'true'
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            os: macos-latest
          - arch: x86_64
            os: macos-15-large

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install package
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Clear IWYU cache
        run: |
          rm -rf ~/.clang-tool-chain/iwyu
          echo "Cleared IWYU cache to force fresh download"

      - name: Wait for CDN propagation
        run: |
          echo "Waiting 60 seconds for GitHub CDN to propagate..."
          sleep 60

      - name: Test IWYU installation
        run: |
          echo "=== Testing IWYU Download and Installation ==="
          uv run clang-tool-chain-iwyu --version

          echo ""
          echo "=== Verifying Installation ==="
          ls -lh ~/.clang-tool-chain/iwyu/darwin/${{ matrix.arch }}/bin/

          echo ""
          echo "=== Checking Dependencies ==="
          otool -L ~/.clang-tool-chain/iwyu/darwin/${{ matrix.arch }}/bin/include-what-you-use
        timeout-minutes: 10

      - name: Run IWYU tests
        run: |
          uv run pytest tests/test_iwyu.py -v
        timeout-minutes: 10

      - name: Report test results
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "::notice::IWYU tests passed on ${{ matrix.arch }}"
          else
            echo "::error::IWYU tests failed on ${{ matrix.arch }}"
            exit 1
          fi

  summary:
    name: Deployment Summary
    needs: [deploy, test-deployment]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Download metadata
        uses: actions/download-artifact@v4
        with:
          pattern: metadata-*
          path: metadata

      - name: Generate summary
        run: |
          echo "# IWYU Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.outputs.deployment_needed }}" = "true" ]; then
            echo "âœ… **Status**: Deployed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Version**: ${{ needs.deploy.outputs.deployed_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Status**: Skipped (version unchanged)" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Version**: ${{ needs.deploy.outputs.deployed_version }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f metadata/metadata-arm64/deployment-info-arm64.json ]; then
            echo "### ARM64" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat metadata/metadata-arm64/deployment-info-arm64.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f metadata/metadata-x86_64/deployment-info-x86_64.json ]; then
            echo "### x86_64" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat metadata/metadata-x86_64/deployment-info-x86_64.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-deployment.result }}" = "success" ]; then
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-deployment.result }}" = "skipped" ]; then
            echo "â­ï¸ Tests skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
          fi
