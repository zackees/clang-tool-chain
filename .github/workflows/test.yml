name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests - ${{ matrix.platform }}-${{ matrix.arch }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        include:
          # Windows x86_64
          - os: windows-latest
            platform: win
            arch: x86_64
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          # macOS x86_64 (Intel)
          - os: macos-13
            platform: darwin
            arch: x86_64
          # macOS ARM64 (Apple Silicon)
          - os: macos-14
            platform: darwin
            arch: arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      shell: bash

    - name: Install dependencies
      run: |
        uv venv
        uv pip install -e ".[dev]"
      shell: bash

    - name: Run linters
      run: |
        uv run ruff check src tests
        uv run black --check src tests
        uv run isort --check-only --profile black src tests
      shell: bash

    - name: Run type checkers
      run: |
        uv run mypy src tests
      shell: bash
      continue-on-error: true

    - name: Run unit tests
      run: |
        uv run pytest tests/test_cli.py tests/test_wrapper.py -v --cov=src --cov-report=xml --cov-report=term
      shell: bash

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}

  integration-tests:
    name: Integration Tests - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x86_64
          - os: windows-latest
            platform: win
            arch: x86_64
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          # Linux ARM64
          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64
          # macOS x86_64 (Intel)
          - os: macos-13
            platform: darwin
            arch: x86_64
          # macOS ARM64 (Apple Silicon)
          - os: macos-14
            platform: darwin
            arch: arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      shell: bash

    - name: Install dependencies
      run: |
        uv venv
        uv pip install -e ".[dev]"
      shell: bash

    - name: Display platform information
      run: |
        echo "Runner OS: ${{ runner.os }}"
        echo "Runner Arch: ${{ runner.arch }}"
        echo "Matrix Platform: ${{ matrix.platform }}"
        echo "Matrix Arch: ${{ matrix.arch }}"
        uname -a || echo "uname not available"
        python --version
      shell: bash

    - name: Verify platform detection
      run: |
        uv run python -c "import platform; print(f'System: {platform.system()}'); print(f'Machine: {platform.machine()}')"
      shell: bash

    - name: Test CLI info command (pre-download)
      run: |
        uv run clang-tool-chain info || echo "Info command failed (expected before download)"
      shell: bash
      continue-on-error: true

    - name: Test automatic toolchain download
      run: |
        # This should trigger automatic download and installation
        uv run clang-tool-chain-c --version
      shell: bash
      timeout-minutes: 15

    - name: Debug - Show complete toolchain directory structure
      run: |
        echo "=========================================="
        echo "COMPLETE ~/.clang-tool-chain DIRECTORY TREE"
        echo "=========================================="
        if [ -d ~/.clang-tool-chain ]; then
          echo ""
          echo "Directory exists at: ~/.clang-tool-chain"
          echo ""
          echo "Complete file tree:"
          find ~/.clang-tool-chain -type f -o -type d | head -500 || true
          echo ""
          echo "=========================================="
          echo "DETAILED FILE LISTING (first 300 files)"
          echo "=========================================="
          find ~/.clang-tool-chain -type f -ls | head -300 || true
          echo ""
          echo "=========================================="
          echo "BIN DIRECTORY CONTENTS"
          echo "=========================================="
          if [ -d ~/.clang-tool-chain/clang/${{ matrix.platform }}/${{ matrix.arch }}/bin ]; then
            ls -laR ~/.clang-tool-chain/clang/${{ matrix.platform }}/${{ matrix.arch }}/bin
          else
            echo "Bin directory not found!"
            echo "Looking for any bin directories:"
            find ~/.clang-tool-chain -type d -name bin -ls || true
          fi
          echo ""
          echo "=========================================="
          echo "DIRECTORY SIZES"
          echo "=========================================="
          du -h -d 3 ~/.clang-tool-chain | sort -h || true
        else
          echo "~/.clang-tool-chain does not exist!"
        fi
      shell: bash
      continue-on-error: true

    - name: Verify installation info
      run: |
        uv run clang-tool-chain info
        uv run clang-tool-chain list-tools
        uv run clang-tool-chain path
      shell: bash

    - name: Test all wrapper commands
      run: |
        # Test that all commands exist and show version/help
        uv run clang-tool-chain-c --version
        uv run clang-tool-chain-cpp --version
        uv run clang-tool-chain-ld --version || uv run clang-tool-chain-ld --help
        uv run clang-tool-chain-ar --version || uv run clang-tool-chain-ar --help
        uv run clang-tool-chain-nm --version || uv run clang-tool-chain-nm --help
        uv run clang-tool-chain-objdump --version || uv run clang-tool-chain-objdump --help
      shell: bash
      timeout-minutes: 5

    - name: Run integration tests
      run: |
        uv run pytest tests/test_integration.py -v --tb=short
      shell: bash
      timeout-minutes: 10

    - name: Run IWYU tests
      run: |
        uv run pytest tests/test_iwyu.py -v --tb=short
      shell: bash
      timeout-minutes: 15

    - name: Create test C program
      run: |
        cat > test_hello.c << 'EOF'
        #include <stdio.h>
        int main() {
            printf("Hello from %s %s!\n", "${{ matrix.platform }}", "${{ matrix.arch }}");
            return 0;
        }
        EOF
      shell: bash

    - name: Create test C++ program
      run: |
        cat > test_hello.cpp << 'EOF'
        #include <iostream>
        int main() {
            std::cout << "Hello C++ from ${{ matrix.platform }} ${{ matrix.arch }}!" << std::endl;
            return 0;
        }
        EOF
      shell: bash

    - name: Test C compilation and execution
      run: |
        uv run clang-tool-chain-c test_hello.c -o test_hello
        if [ "${{ matrix.platform }}" = "win" ]; then
          ./test_hello.exe
        else
          ./test_hello
        fi
      shell: bash
      timeout-minutes: 5

    - name: Test C++ compilation and execution
      run: |
        uv run clang-tool-chain-cpp test_hello.cpp -o test_hello_cpp
        if [ "${{ matrix.platform }}" = "win" ]; then
          ./test_hello_cpp.exe
        else
          ./test_hello_cpp
        fi
      shell: bash
      timeout-minutes: 5

    - name: Test toolchain with optimization flags
      run: |
        uv run clang-tool-chain-c -O2 test_hello.c -o test_hello_opt
        if [ "${{ matrix.platform }}" = "win" ]; then
          ./test_hello_opt.exe
        else
          ./test_hello_opt
        fi
      shell: bash

    - name: Verify toolchain binaries location
      run: |
        uv run clang-tool-chain path clang-tool-chain-c
        ls -la $(uv run clang-tool-chain path) || dir $(uv run clang-tool-chain path)
      shell: bash

  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: |
        uv venv
        uv pip install -e ".[dev]"

    - name: Run ruff
      run: uv run ruff check src tests

    - name: Run black
      run: uv run black --check src tests

    - name: Run isort
      run: uv run isort --check-only --profile black src tests

    - name: Run mypy
      run: uv run mypy src tests
      continue-on-error: true

    - name: Run pyright
      run: uv run pyright src tests
      continue-on-error: true
