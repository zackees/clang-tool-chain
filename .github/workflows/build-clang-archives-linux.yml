name: build-clang-archives-linux

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture to build (x86_64 or arm64 or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - x86_64
          - arm64
          - both

jobs:
  build-linux-x86_64:
    name: Build Linux x86_64 Archive
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.arch == 'x86_64' || github.event.inputs.arch == 'both' }}

    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: |
        cd downloads-bins
        uv venv
        uv pip install zstandard

    - name: Verify Docker is available
      run: docker version

    - name: Build Linux x86_64 archive with bundled libunwind
      run: |
        cd downloads-bins
        echo "Building Linux x86_64 archive..."
        echo "This will use Docker to extract libunwind headers and libraries"
        uv run python tools/fetch_and_archive.py --platform linux --arch x86_64
      timeout-minutes: 60

    - name: List built archives
      run: |
        echo "Built archives:"
        ls -la downloads-bins/assets/clang/linux/x86_64/

    - name: Verify libunwind in archive
      run: |
        cd downloads-bins/assets/clang/linux/x86_64
        ARCHIVE=$(ls *.tar.zst | head -1)
        echo "Checking archive: $ARCHIVE"

        # Extract to temp directory
        mkdir -p /tmp/verify-archive
        cd /tmp/verify-archive
        tar --use-compress-program=unzstd -xf "$OLDPWD/$ARCHIVE"

        # Check for libunwind headers
        echo "Checking for libunwind headers..."
        find . -name "libunwind.h" -o -name "unwind.h" | head -5

        # Check for libunwind libraries
        echo "Checking for libunwind libraries..."
        find . -name "libunwind*.so*" | head -5

    - name: Upload archive artifact
      uses: actions/upload-artifact@v4
      with:
        name: clang-linux-x86_64
        path: |
          downloads-bins/assets/clang/linux/x86_64/*.tar.zst
          downloads-bins/assets/clang/linux/x86_64/*.sha256
          downloads-bins/assets/clang/linux/x86_64/manifest.json
        retention-days: 30

  build-linux-arm64:
    name: Build Linux ARM64 Archive
    runs-on: ubuntu-24.04-arm
    if: ${{ github.event.inputs.arch == 'arm64' || github.event.inputs.arch == 'both' }}

    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: |
        cd downloads-bins
        uv venv
        uv pip install zstandard

    - name: Verify Docker is available
      run: docker version

    - name: Build Linux ARM64 archive with bundled libunwind
      run: |
        cd downloads-bins
        echo "Building Linux ARM64 archive..."
        echo "This will use Docker to extract libunwind headers and libraries"
        uv run python tools/fetch_and_archive.py --platform linux --arch arm64
      timeout-minutes: 60

    - name: List built archives
      run: |
        echo "Built archives:"
        ls -la downloads-bins/assets/clang/linux/arm64/

    - name: Verify libunwind in archive
      run: |
        cd downloads-bins/assets/clang/linux/arm64
        ARCHIVE=$(ls *.tar.zst | head -1)
        echo "Checking archive: $ARCHIVE"

        # Extract to temp directory
        mkdir -p /tmp/verify-archive
        cd /tmp/verify-archive
        tar --use-compress-program=unzstd -xf "$OLDPWD/$ARCHIVE"

        # Check for libunwind headers
        echo "Checking for libunwind headers..."
        find . -name "libunwind.h" -o -name "unwind.h" | head -5

        # Check for libunwind libraries
        echo "Checking for libunwind libraries..."
        find . -name "libunwind*.so*" | head -5

    - name: Upload archive artifact
      uses: actions/upload-artifact@v4
      with:
        name: clang-linux-arm64
        path: |
          downloads-bins/assets/clang/linux/arm64/*.tar.zst
          downloads-bins/assets/clang/linux/arm64/*.sha256
          downloads-bins/assets/clang/linux/arm64/manifest.json
        retention-days: 30
