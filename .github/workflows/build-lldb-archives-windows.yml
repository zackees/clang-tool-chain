name: Build LLDB Archives (Windows)

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM version to build (e.g., 21.1.5)'
        required: true
        default: '21.1.5'

jobs:
  build-lldb-windows-x86_64:
    runs-on: windows-latest
    timeout-minutes: 120  # 2 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyzstd requests
        shell: bash

      - name: Download Python 3.10 embeddable package
        run: |
          cd downloads-bins/work
          mkdir -p python_windows_x64
          cd python_windows_x64

          echo "Downloading Python 3.10.11 embeddable package for Windows AMD64..."
          # Python 3.10.11 embeddable package (9.8 MB)
          # Contains python310.dll and python310.zip
          curl -L -o python-3.10.11-embed-amd64.zip \
            https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip

          echo "Download complete. File size:"
          ls -lh python-3.10.11-embed-amd64.zip

          echo "Extracting Python embeddable package..."
          unzip -q python-3.10.11-embed-amd64.zip

          echo "Extracted files:"
          ls -lh

          echo "Verifying python310.dll exists..."
          if [ -f "python310.dll" ]; then
            echo "✓ python310.dll found ($(stat -c%s python310.dll 2>/dev/null || stat -f%z python310.dll) bytes)"
          else
            echo "✗ python310.dll NOT FOUND"
            exit 1
          fi
        shell: bash

      - name: Extract LLDB from existing clang archive
        run: |
          cd downloads-bins/work
          mkdir -p lldb_windows_x64_extracted
          cd lldb_windows_x64_extracted

          echo "Extracting clang archive to get LLDB binaries..."
          # The clang archive already contains LLDB binaries
          python -c "
import sys
sys.path.insert(0, '../../..')
import tarfile
import pyzstd
from pathlib import Path

archive_path = Path('../../assets/clang/win/x86_64/llvm-21.1.5-win-x86_64.tar.zst')
print(f'Extracting {archive_path}...')

with pyzstd.open(archive_path, 'rb') as zst_file:
    with tarfile.open(fileobj=zst_file, mode='r|') as tar:
        # Extract only LLDB-related files
        members_to_extract = []
        for member in tar:
            if any(name in member.name for name in ['lldb.exe', 'lldb-server.exe', 'lldb-argdumper.exe', 'liblldb.dll']):
                members_to_extract.append(member)
                print(f'  Extracting: {member.name} ({member.size / (1024*1024):.2f} MB)')

        # Reset and extract
        pass

with pyzstd.open(archive_path, 'rb') as zst_file:
    with tarfile.open(fileobj=zst_file, mode='r|') as tar:
        for member in tar:
            if any(name in member.name for name in ['lldb.exe', 'lldb-server.exe', 'lldb-argdumper.exe', 'liblldb.dll']):
                tar.extract(member, path='.')

print('Extraction complete')
"

          echo "Extracted LLDB binaries:"
          find . -name "lldb*.exe" -o -name "liblldb.dll"
        shell: bash

      - name: Prepare Python modules for LLDB
        run: |
          cd downloads-bins/work
          mkdir -p python_windows_lldb
          cd python_windows_lldb

          echo "Preparing Python modules directory structure for LLDB..."

          # Create Lib/site-packages/lldb directory
          mkdir -p Lib/site-packages/lldb

          # Copy python310.dll from embeddable package
          cp ../python_windows_x64/python310.dll ./
          echo "✓ Copied python310.dll"

          # Copy python310.zip (Python standard library)
          cp ../python_windows_x64/python310.zip ./
          echo "✓ Copied python310.zip"

          # Extract LLDB Python module from existing archive
          echo "Extracting LLDB Python module from current archive..."
          cd Lib/site-packages/lldb

          # Download and extract just the Python module from current LLDB archive
          python -c "
import sys
import tarfile
import pyzstd
from pathlib import Path
import urllib.request

# Download current LLDB archive temporarily
archive_url = 'https://media.githubusercontent.com/media/zackees/clang-tool-chain-bins/main/assets/lldb/win/x86_64/lldb-21.1.5-win-x86_64.tar.zst'
print(f'Downloading current LLDB archive to extract Python module...')
archive_path = Path('lldb-current.tar.zst')
urllib.request.urlretrieve(archive_url, archive_path)
print(f'Downloaded {archive_path.stat().st_size / (1024*1024):.2f} MB')

# Extract Python module files
print('Extracting LLDB Python module...')
with pyzstd.open(archive_path, 'rb') as zst_file:
    with tarfile.open(fileobj=zst_file, mode='r|') as tar:
        for member in tar:
            if 'python/Lib/site-packages/lldb/' in member.name:
                # Strip the python/Lib/site-packages/lldb/ prefix
                member.name = member.name.split('python/Lib/site-packages/lldb/', 1)[1]
                if member.name:  # Skip if empty (the directory itself)
                    print(f'  {member.name}')
                    tar.extract(member, path='.')

# Clean up
archive_path.unlink()
print('✓ LLDB Python module extracted')
"

          cd ../../../..
          echo "Python modules directory prepared:"
          ls -lhR python_windows_lldb/
        shell: bash

      - name: Build LLDB archive with Python 3.10
        run: |
          cd downloads-bins/tools

          # Find the extracted LLVM directory
          LLVM_ROOT=$(find ../work/lldb_windows_x64_extracted -type d -name "bin" | head -1 | xargs dirname)
          echo "Using LLVM root: $LLVM_ROOT"

          # Build LLDB archive with Python 3.10 modules (including python310.dll)
          python create_lldb_archives.py \
            --platform win \
            --arch x86_64 \
            --source-dir "$LLVM_ROOT" \
            --with-python \
            --python-dir ../work/python_windows_lldb
        shell: bash

      - name: Verify archive was created
        run: |
          echo "Checking for created archive..."
          ls -lh downloads-bins/assets/lldb/win/x86_64/

          echo "Archive contents:"
          file downloads-bins/assets/lldb/win/x86_64/*.tar.zst || echo "file command not available"

          echo "Checksums:"
          cat downloads-bins/assets/lldb/win/x86_64/*.sha256

          # Verify python310.dll is in the archive
          echo ""
          echo "Verifying python310.dll is in bin/ directory of archive:"
          python -c "
import tarfile
import pyzstd
from pathlib import Path

archive = Path('downloads-bins/assets/lldb/win/x86_64/lldb-${{ github.event.inputs.llvm_version }}-win-x86_64.tar.zst')
with pyzstd.open(archive, 'rb') as zst_file:
    with tarfile.open(fileobj=zst_file, mode='r|') as tar:
        has_python_dll = False
        for member in tar:
            if 'bin/python310.dll' in member.name:
                print(f'✓ Found: {member.name} ({member.size / (1024*1024):.2f} MB)')
                has_python_dll = True
                break

        if not has_python_dll:
            print('✗ ERROR: python310.dll NOT found in archive!')
            exit(1)
"
        shell: bash

      - name: Upload Windows x86_64 archive
        uses: actions/upload-artifact@v4
        with:
          name: lldb-windows-x86_64
          path: |
            downloads-bins/assets/lldb/win/x86_64/lldb-*.tar.zst
            downloads-bins/assets/lldb/win/x86_64/lldb-*.tar.zst.sha256
          retention-days: 30

  summary:
    needs: [build-lldb-windows-x86_64]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Job summary
        run: |
          echo "# LLDB Archive Build Summary (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**LLVM Version:** ${{ github.event.inputs.llvm_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-lldb-windows-x86_64.result }}" == "success" ]; then
            echo "✅ **Windows x86_64:** Built successfully with python310.dll" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Windows x86_64:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What's Included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- LLDB binaries (lldb.exe, lldb-server.exe, lldb-argdumper.exe, liblldb.dll)" >> $GITHUB_STEP_SUMMARY
          echo "- **python310.dll** (4.3 MB) - Python 3.10 runtime" >> $GITHUB_STEP_SUMMARY
          echo "- python310.zip - Python 3.10 standard library" >> $GITHUB_STEP_SUMMARY
          echo "- LLDB Python module (_lldb.cp310-win_amd64.pyd)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract archives to \`downloads-bins/assets/lldb/win/x86_64/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Update manifest with new SHA256 checksum" >> $GITHUB_STEP_SUMMARY
          echo "4. Commit to downloads-bins submodule" >> $GITHUB_STEP_SUMMARY
          echo "5. Update main repository submodule reference" >> $GITHUB_STEP_SUMMARY
          echo "6. Test with \`clang-tool-chain-lldb --version\`" >> $GITHUB_STEP_SUMMARY
          echo "7. Verify tests pass: \`pytest tests/test_lldb.py -v\`" >> $GITHUB_STEP_SUMMARY
        shell: bash
